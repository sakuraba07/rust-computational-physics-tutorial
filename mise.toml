[tools]
"cargo:mdbook" = "latest"
"cargo:mdbook-d2" = "latest"
# "cargo:mdbook-typst-math" = "latest"
"cargo:https://github.com/duskmoon314/mdbook-typst-math" = "branch:main"
"cargo:mdbook-last-changed" = "latest"
"cargo:pagefind" = { version = "latest", features = "extended" }
"cargo:lychee" = "latest"
"cargo:miniserve" = "latest"
"cargo:dprint" = "latest"
"github:terrastruct/d2" = { version = "latest", bin_path = "d2-v{version}/bin" }

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf book"

[tasks.build]
description = "Build the book and check for broken links"
run = ["mise run build-core", "mise run check"]

[tasks.build-core]
description = "Build mdbook and generate search index"
depends = ["clean"]
run = """
echo "ğŸ“š Building mdbook..."
mdbook build
echo "âœ… Build completed\n"

echo "ğŸ” Generating search index..."
pagefind --site book --force-language ja --exclude-selectors "nav,.sidebar,.menu-bar,.nav-wrapper,.nav-wide-wrapper,#mdbook-sidebar,#mdbook-menu-bar,.mdbook-help-container"
echo "âœ… Index generated\n"

echo "ğŸ‰ Done!"
"""

[tasks.check]
description = "Check links and formatting"
run = """
echo "ğŸ¨ Checking formatting..."
dprint check
echo "âœ… Formatting checked\n"
echo "ğŸ”— Checking links..."
lychee --root-dir book book/
echo "âœ… Links checked\n"
"""

[tasks.serve]
description = "Build and serve the book with search functionality"
depends = ["build"]
run = """
echo "ğŸš€ Starting server on http://localhost:3000..."
echo "Press Ctrl+C to stop\n"
miniserve book --port 3000 --index index.html
"""
