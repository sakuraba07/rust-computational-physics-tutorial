# 重点サンプリング

単純なモンテカルロ積分では、関数の値がほとんど $0$ であるような広大な領域を律儀にサンプリングし、貴重な計算資源を浪費してしまうことがあります。これを改善するのが**重点サンプリング (Importance Sampling)** です。

## 原理

積分 $I = integral f(x) dd(x)$ を、ある確率密度関数 $p(x)$ を用いて以下のように書き換えます。

$$ I = integral [f(x) / p(x)] p(x) dd(x) $$

これは、**確率分布 $p(x)$ に従って $x$ をサンプリングし、その点での値 $f(x) / p(x)$ の平均をとる**ことに相当します。

$$ I approx 1/N sum_(i=1)^N f(x_i) / p(x_i), quad x_i sim p(x) $$

## なぜ誤差が減るのか

もし、積分の寄与が大きい（$f(x)$ の絶対値が大きい）場所ほど $p(x)$ も大きくなるように選べば、$f(x) / p(x)$ の値のばらつき（分散）が小さくなり、より少ない試行回数で精度の高い結果が得られます。

極端な話、$p(x)$ が $f(x)$ に完全に比例するように選べば、分散はゼロになります（ただしその場合、規格化定数を知るために結局積分が必要になるという循環参照に陥りますが、近似的な形を知っているだけでも絶大な効果があります）。

## 実装のポイント

1. **適切な $p(x)$ の選択**: $f(x)$ の「形」をよく反映し、かつ乱数生成が容易な分布を選びます。
2. **重みの補正**: $1/p(x)$ をかけることで、サンプリングの偏りを正しく補正します。

## 具体例：指数減衰を含む関数の積分

積分 $I = integral_0^infinity e^(-x) / (1 + x^2) dd(x)$ を計算してみましょう。
この関数は $x$ が大きくなると急激に $0$ に近づくため、広い範囲を一様にサンプリングするのは非効率です。そこで、確率密度関数 $p(x) = e^(-x)$ に従ってサンプリングを行います。

### Rustによる実装

```rust
use rand::prelude::*;
use rand_distr::{Distribution, Exp};

fn main() {
    let n = 100_000;
    let mut rng = thread_rng();
    
    // 積分対象の関数 f(x)
    let f = |x: f64| (-x).exp() / (1.0 + x * x);
    
    // 1. 単純なモンテカルロ積分 (比較用)
    // [0, 10] の範囲で一様サンプリング (10以降は無視)
    let mut sum_simple = 0.0;
    let limit = 10.0;
    for _ in 0..n {
        let x = rng.gen_range(0.0..limit);
        sum_simple += f(x);
    }
    let res_simple = limit * sum_simple / (n as f64);

    // 2. 重点サンプリング
    // p(x) = e^(-x) (指数分布) に従ってサンプリング
    let exp_dist = Exp::new(1.0).unwrap();
    let mut sum_importance = 0.0;
    for _ in 0..n {
        let x = exp_dist.sample(&mut rng);
        // f(x) / p(x) = (e^(-x) / (1+x^2)) / e^(-x) = 1 / (1+x^2)
        sum_importance += 1.0 / (1.0 + x * x);
    }
    let res_importance = sum_importance / (n as f64);

    println!("Simple MC (N={}):     {:.6}", n, res_simple);
    println!("Importance (N={}):   {:.6}", n, res_importance);
    // 解析解に近い値: 約 0.62145
}
```

### なぜ重点サンプリングが良いのか

上の例では、`f(x) / p(x)` が `1 / (1 + x^2)` という非常に滑らかな関数（ばらつきの少ない関数）になりました。
単純なMCでは、指数関数 $e^{-x}$ の激しい変化をそのまま乱数で捉えようとするため、サンプルごとの値の差が大きく、収束に時間がかかります。
一方、重点サンプリングでは「重要な場所を多く叩き、かつその重みを補正する」ことで、極めて効率的に（少ない $N$ で）高い精度を得ることができます。

---

[次節](./mcmc.md)では、さらに複雑な分布からサンプリングを行うための「マルコフ連鎖モンテカルロ法」について学びます。
